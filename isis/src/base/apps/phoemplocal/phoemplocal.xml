<?xml version="1.0" encoding="UTF-8"?>

<application name="phoemplocal" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://isis.astrogeology.usgs.gov/Schemas/Application/application.xsd">
 
  <brief>
    Fit empirical photometric functions to Hapke
  </brief>
  
  <description>
    <pre>
    This program finds lunar-Lambert or Minnaert photometric functions
    to approximate a more realistic but more complex Hapke model.
    The program is based on PHO_FIT_GLOBAL with the following differences:
    The fit is performed at a single geometry rather than for a range of phase 
    angles.  The user specifies the phase angle and the incidence and emission 
    angles of the mean ground plane (datum), as well as the RMS slope relative to 
    the dataum.  Artificial data are then created, with slopes drawn from an 
    isotropic Gaussian distribution relative to the datum.  The simpler model is 
    fit at these orientations to the Hapke model by adjusting its one parameter 
    and its overall brightness so that the sum-squared-residual between the two is 
    minimized.  Both the parameter (which, for both types of simple model, mainly 
    controls limb darkening) and the brightness (normalized as an empirical phase 
    curve) are reported.

    This program should serve as a clear example for developing a new program 
    PHO_FIT_IMAGE to fit the parameter of an empirical photometric function to 
    part of an actual image. The differences can be summarized as follows:
         1) Fit is done only once (not in a table vs. phase angle)
            since the input image has a fixed geometry.
         2) The data to be fit *to* are obtained from an ISIS cube plane
           rather than calculated in GET_HAPKE_IMG.
         3) Similarly, the incidence, emission, and phase angles are
            obtained from backplanes of the same cube and maintained
            in buffers corresponding point-for-point with the image.
            The routine to pull values out of these buffers at the
            current pixel can look identical to GET_ANGLES.
         4) Both image data and angles should be stored in R*4 buffers
            and converted to double precision before being used.
         5) Optionally, a region-of-interest mask could be obtained
            from a backplane and only those pixels in the ROI used
            in the fit.  This would be in addition on the incidence
            and emission angle tests already in the code.
    </pre>
  </description>

  <category>
    <categoryItem>Radiometric and Photometric Correction</categoryItem>
  </category>

  <history>
    <change name="Randy Kirk" date= "1999-11-16">
        USGS Flagstaff Original Version
    </change>
    <change name="Janet Barrett"  date="2003-01-13">
      Ported pho_fit_local from the VAX and renamed it 
      pho_emp_local in isis2
    </change>
    <change name="Sharmila Prasad" date="2011-08-04">
      Isis3 Original version, pho_emp_local ported from isis2 to isis3 
      phoemplocal 
    </change>
  </history>

  <groups>
    <group name="Files">
      <parameter name="TO">
        <type>filename</type>
        <fileMode>output</fileMode>
        <brief>
            Output text file to contain fit parameters
        </brief>
        <internalDefault>
          None Specified
        </internalDefault>
        <description>
          The output file has a table whose columns give the phase angle,
          best-fit limb darkening parameter, best-fit brightness both in absolute units
          and relative to the zero phase model and RMS residual to the fit.
        </description>
        <filter>
          *.txt
        </filter>
      </parameter>
      <parameter name="APPEND">
        <type>boolean</type>
        <brief>
          Append Output to File
        </brief>
        <description>
          If this option is selected, the output from the application will be appended to the file.
          If it is not selected, any information in the TO file will be overwritten.
        </description>
        <default><item>FALSE</item></default>
      </parameter>
    </group>

     <group name="User Note">
       <parameter name="NOTE">
        <type>string</type>
        <brief>
            User note to be added to output file
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          The user can specify a note to be added to the output file using this parameter.
        </description>
       </parameter>
    </group>

     <group name="Hapke">
      <parameter name="PHTNAME">
        <type>combo</type>
        <internalDefault>HAPKEHEN</internalDefault>
        <default>
          <item>HAPKEHEN</item>
        </default>
        <brief>
          Surface Photometric Model
        </brief>
        <description>
          A Hapke (1981; 1984; 1966) photometric model is always used as the model
          to which empirical functions are fitted. The options correspond to variants
          of the Hapke model with different types of model for the single particle
          phase (scattering) function.
        </description>

        <list>
          <option value="HAPKEHEN">
            <brief> 
              Use Henyey-Greenstein scattering function in Hapke photometric model
            </brief>
            <description>
              This is the two-parameter version of the Henyey-Greenstein single
              particle phase function, with parameters HG1 and HG2.
            </description>
            <exclusions>
              <item>BH</item>
              <item>CH</item>
            </exclusions>
          </option>
          <option value="HAPKELEG">
            <brief> 
              Use Legendre-Polynomial in Hapke photometric model
            </brief>
            <description>
              This is a two-term Legendre Polynomial expansion of the single
              particle phase function, with parameters BH and CH.
            </description>
            <exclusions>
              <item>HG1</item>
              <item>HG2</item>
            </exclusions>
          </option>
        </list>
      </parameter>

      <parameter name="WH">
        <type>double</type>
        <brief>
          Single Scattering Albedo
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Single-scattering albedo of surface particles. See Hapke
          (1981).  Not to be confused with albedo WHA of the atmospheric
          particles.
        </description> 
      </parameter>

      <parameter name="HH">
        <type>double</type>
        <brief>
          Opposition Surge Width
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Opposition Surge Width. ZEROs are strongly advised as the simple models 
          do not fit the opposition effect well. See Hapke (1984).
        </description> 
      </parameter>

      <parameter name="B0">
        <type>double</type>
        <brief>
          Opposition Surge Strength
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Opposition Surge Strength. Magnitude of the opposition effect for
          the surface. ZEROs are strongly advised as the simple models do
          not fit the opposition effect well. See Hapke (1984).
        </description>
      </parameter>

      <parameter name="THETA">
        <type>double</type>
        <brief>
          Surface roughness in degrees
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Small scale surface roughness in degrees. "Macroscopic roughness"
          of the surface as it affects the photometric behavior. This is the
          root mean squared (RMS) slope at scales larger than the distance
          photons penetrate the surface but smaller than a pixel.  See
          Hapke (1986).
        </description>
      </parameter> 

      <parameter name="HG1">
        <type>double</type>
        <brief>
          Henyey-Greenstein coefficient 1
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Asymmetry parameter used in the Henyey-Greenstein model for the
          scattering phase function of single particles in the surface,
          used if PHTNAME=HAPKEHEN. See Hapke (1981). The two-parameter
          Henyey-Greenstein function is P(phase) = (1-HG2) *
          (1-HG1**2)/(1+HG1**2+2*HG1*COS(PHASE))**1.5 + HG2 *
          (1-HG1**2)/(1+HG1**2-2*HG1*COS(PHASE))**1.5
        </description>
      </parameter>

      <parameter name="HG2">
        <type>double</type>
        <brief>
          Henyey-Greenstein coefficient 2
        </brief> 
        <internalDefault>None Specified</internalDefault>
        <description>
          Second parameter of the two-parameter Henyey-Greenstein model
          for the scattering phase function of single particles in the
          surface, used if PHTNAME=HAPKEHEN. This parameter controls the
          proportions in a linear mixture of ordinary Heneyey-Greenstein
          phase functions with asymmetry parameters equal to +HG1 and -HG1.
          See HG1 for the full formula.
        </description>
      </parameter>

      <parameter name="BH">
        <type>double</type>
        <brief>
          Legendre coefficient 1
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Coefficient of the first order Legendre polynomial in the
          single particle phase function. When PHTNAME=HAPKELEG, a
          two-term Legendre polynomial expansion is used to represent
          the scattering phase function of single particles in the
          surface:  P(PHASE) = 1 + BH * P1(COS(PHASE)) + CH * P2(COS(PHASE))
          where P1 and P2 are the first and second order Legendre
          polynomials.
        </description>
      </parameter>

      <parameter name="CH">
        <type>double</type>
        <brief>
          Legendre coefficient 2
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Coefficient of the second order Legendre polynomial in the
          single particle phase function. When PHTNAME=HAPKELEG, a
          two-term Legendre polynomial expansion is used to represent
          the scattering phase function of single particles in the
          surface:  P(PHASE) = 1 + BH * P1(COS(PHASE)) + CH * P2(COS(PHASE))
          where P1 and P2 are the first and second order Legendre
          polynomials.
        </description>
      </parameter>
    </group>

    <group name="Empirical">
      <parameter name="MODEL">
        <type>combo</type>
        <internalDefault>LunarLambert</internalDefault>
        <brief>
          Type of empirical photometric function fitted to the Hapke model.
        </brief>
        <description>
          Determines which empirical photometric function will be fitted
          to the Hapke model. The tables of B and L or B and K can be used with
          the lunar-Lambert empirical or Minnaert empirical photometric
          functions in the photometric normalization program photomet.
        </description>
        <list>
          <option value="LUNARLAMBERT">
            <brief>
              Lunar-Lambert Empirical Photometric Function
            </brief>
            <description>
              Fit the Lunar-Lambert Empirical Photometric Function to the
              Hapke Model. The empirical lunar-Lambert model as defined by
              McEwen (1991) and used by the program photomet is:
              Lunar-Lambert FUNC=B(PHASE) * ((1-L(PHASE))*u0 + 2*L(PHASE)*u0/(u0+u))
            </description>
          </option>
          <option value="MINNAERT">
            <brief>
              Minnaert Empirical Photometric Function
            </brief>
            <description>
              Fit the Minnaert Empirical Photometric Function to the
              Hapke Model. The empirical Minnaert model as defined by
              McEwen (1991) and used by the program photomet is:
              Minnaert FUNC=B(PHASE) * u0**K(PHASE) * u**(K(PHASE)-1)
            </description>
          </option>
        </list>
      </parameter>
    </group>

    <group name="Atmospheric Scattering Model">
      <parameter name="ATMNAME">
        <type>combo</type>
        <internalDefault>NONE</internalDefault>
        <default>
          <item>NONE</item>
        </default>
        <brief>
          Type of atmospheric scattering model (if any) modifying the surface
          scattering
	</brief>
        <description>
          If an option other than NONE is selected, an atmospheric scattering
          model will be included in addition to the surface Hapke model as
          part of the physical model to which the empirical model is fitted.
          Six atmospheric models are currently provided, falling into three
          classes that differ in their treatment of the single particle
          scattering function for atmospheric particles. Each of these classes
          of model can be evaluated to a first order (faster) or second order
          (more accurate) approximation. Atmospheric scattering in all these
          models both attenuates the surface signal and adds its own (uniform)
          contribution to the image radiance. Therefore, unless NONE is
          selected, it makes sense to also set IORD=YES so that the additive
          contribution of the atmosphere will be modeled by an additive
          constant in the fit. This approach is useful in preparing for 
          photoclinometry (shape from shading), for which images are normally
          preprocessed by subtracting a uniform haze component that corresponds
          to the additive term in the fit with IORD=YES.
        </description>
        <list>  
          <option value="NONE">
            <brief>
              No Atmospheric Scattering Model
            </brief>
            <description>
              The radiance from the Hapke surface is not modified by
              atmospheric scattering.
            </description>
            <exclusions>
              <item>TAU</item>
              <item>WHA</item>
              <item>HGA</item>
              <item>HNORM</item>
              <item>IORD</item>
              <item>BHA</item>
            </exclusions>
          </option>
          <option value="ISOTROPIC1">
            <brief>
              First Order Isotropic
            </brief>
            <description> 
              Atmospheric particles are assumed to scatter light isotropically.
              The effects of this scattering are calculated exactly to first
              order.
            </description> 
            <inclusions> 
              <item>TAU</item>
              <item>WHA</item>
              <item>HNORM</item>
              <item>IORD</item>
            </inclusions>
            <exclusions>
              <item>HGA</item>
              <item>BHA</item>
            </exclusions>
          </option>
          <option value="ISOTROPIC2">
            <brief>
              Second Order Isotropic
            </brief>
            <description>
              Atmospheric particles are assumed to scatter light isotropically.
              The effects of this scattering are calculated exactly to second
              order.
            </description>
            <inclusions> 
              <item>TAU</item>
              <item>WHA</item>
              <item>HNORM</item>
              <item>IORD</item>
            </inclusions>
            <exclusions>
              <item>HGA</item>
              <item>BHA</item>
            </exclusions>
          </option>
          <option value="ANISOTROPIC1">
            <brief>
              First Order Anisotropic
            </brief>
            <description>
              Atmospheric particles are assumed to scatter light according
              to a Legendre polynomial model with a single term. The effects
              of this scattering are calculated exactly to first order.
            </description>
            <inclusions> 
              <item>TAU</item>
              <item>WHA</item>
              <item>BHA</item>
              <item>HNORM</item>
              <item>IORD</item>
            </inclusions>
            <exclusions>
              <item>HGA</item>
            </exclusions>
          </option>
          <option value="ANISOTROPIC2">
            <brief>
              Second Order Anisotropic
            </brief>
            <description>
              Atmospheric particles are assumed to scatter light according to
              a Legendre polynomial model with a single term. The effects of
              this scattering are calculated exactly to second order.
            </description>
            <inclusions> 
              <item>TAU</item>
              <item>WHA</item>
              <item>BHA</item>
              <item>HNORM</item>
              <item>IORD</item>
            </inclusions>
            <exclusions>
              <item>HGA</item>
            </exclusions>
          </option>
          <option value="HAPKEATM1">
            <brief>
              First Order Henyey-Greenstein
            </brief>
            <description>
              Atmospheric particles are assumed to scatter light according to
              a single parameter Henyey-Greenstein function (see the description
              of the surface scattering parameter HG1 for the equation that
              combines two such functions for surface particles). The effects
              of this scattering are approximated by using a first order solution
              for multiple scattering by isotropic particles and making a
              correction to the distribution of singly scattered radiation. The
              model is called HAPKEATM1 because this correction for the single
              particle phase function is similar to the one developed by Hapke
              (1981) for surface scattering.
            </description>
            <inclusions> 
              <item>TAU</item>
              <item>WHA</item>
              <item>HGA</item>
              <item>HNORM</item>
              <item>IORD</item>
            </inclusions>
            <exclusions>
              <item>BHA</item>
            </exclusions>
          </option>
          <option value="HAPKEATM2">
            <brief>
              Second Order Henyey-Greenstein
            </brief>
            <description>
              Atmospheric particles are assumed to scatter light according to
              a single parameter Henyey-Greenstein function (see the description
              of the surface scattering parameter HG1 for the equation that
              combines two such functions for surface particles). The effects
              of this scattering are approximated by using a second order solution
              for multiple scattering by isotropic particles and making a
              correction to the distribution of singly scattered radiation. The
              model is called HAPKEATM2 because this correction for the single
              particle phase function is similar to the one developed by Hapke
              (1981) for surface scattering.
            </description>
            <inclusions> 
              <item>TAU</item>
              <item>WHA</item>
              <item>HGA</item>
              <item>HNORM</item>
              <item>IORD</item>
            </inclusions>
            <exclusions>
              <item>BHA</item>
            </exclusions>
          </option>
        </list>
      </parameter>

      <parameter name="TAU">
        <type>double</type>
        <brief>
          Normal atmospheric optical depth
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Normal atmospheric optical depth
        </description>
      </parameter>

      <parameter name="WHA">
        <type>double</type>
        <brief>
          Single-scattering albedo
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Single-scattering albedo of atmospheric particles, not to be
          confused with the albedo WH of surface particles.
        </description>
      </parameter>

      <parameter name="HGA">
        <type>double</type>
        <brief>
          Henyey-Greenstein coefficient for atmospheric particles
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Parameter used in the Henyey-Greenstein single particle phase
          function for atmospheric particles when ATMNAME=HAPKEATM1 or
          ATMNAME=HAPKEATM2. This is the asymmetry parameter for a single
          term Henyey-Greenstein model P(PHASE) = (1-HGA**2)/
          (1+HGA**2+2*HGA*COS(PHASE))**1.5
          Not to be confused with corresponding parameter HG1 for the
          surface particles.
        </description>
      </parameter>

      <parameter name="BHA">
        <type>double</type>
        <brief>
          Atmospheric particle Legendre coefficient
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Coefficient of the first order Legendre polynomial in the
          single particle phase function for atmospheric scattering.
          When ATMNAME=ANISOTROPIC1 or ATMNAME=ANISOTROPIC2, a two-term
          Legendre polynomial expansion is used to represent the
          scattering phase function of single particles in the atmosphere:
          P(PHASE) = 1 + BHA * P1(COS(PHASE)) where P1 is the first order
          Legendre polynomial. Not to be confused with the corresponding
          parameter BH for the surface.
        </description>
      </parameter>

      <parameter name="HNORM">
        <type>double</type>
        <brief>
          Atmospheric shell thickness
        </brief>
        <internalDefault>None Specified</internalDefault>
        <description>
          Atmospheric shell thickness normalized to planet radius, used
          to correct the path lengths of atmospheric transmission for the
          spherical geometry of the planet. Default 0.003 is for Mars.
        </description>
      </parameter>

      <parameter name="IORD">
        <type>boolean</type>
        <brief>
          Allow additive offset in fit
        </brief>
        <default>
          <item>false</item>
        </default>
        <description>
          If true, the additive contribution of the atmosphere will be modeled
          by an additive constant in the fit of the empirical function at each
          phase angle.
        </description>
      </parameter>
    </group>

    <group name="Mean Ground Plane(Datum) Geometry">
      <parameter name="EMISSION">
        <type>double</type>
        <internalDefault>None Specified</internalDefault>
        <brief>
          Emission angle
        </brief>
        <description>
          This is the emission angle of the ground plane at a representative
          point in the image of interest, measured between the local vertical
          and the vector from the point on the ground to the spacecraft.
        </description>
      </parameter>

      <parameter name="PHASE">
        <type>double</type>
        <internalDefault>None Specified</internalDefault>
        <brief>
          Phase angle
        </brief>
        <description>
          This is the phase angle at a representative point in the image,
          measured between the vector from that point to the sun and the
          vector from that point to the spacecraft.
        </description>
      </parameter>

      <parameter name="INCIDENCE">
        <type>double</type>
        <internalDefault>None Specified</internalDefault>
        <brief>
          Incidence angle
        </brief>
        <description>
          This is the incidence angle of the ground plane at a representative
          point in the image of interest, measured between the local vertical
          and the vector from the point on the ground to the sun.
        </description>
      </parameter>

      <parameter name="RMS_SLOPE">
        <type>double</type>
        <internalDefault>None Specified</internalDefault>
        <brief>
          Root mean squared slope
        </brief>
        <description>
          The fit will be performed over a set of synthesized data with
          different orientations. Each component (E-W and N-S) of slope
          of these data points is normally distributed with a mean of 
          zero and a standard deviation given by this parameter. The fit
          results should be only weakly dependent on this parameter.
        </description>
      </parameter>
    </group>

    <group name="Random Number Generator">
      <parameter name="SEED">
        <type>boolean</type>
        <brief>
          User Specified Seed
        </brief>
        <default><item>false</item></default>
        <description>
          If enabled, this program uses the user defined number as the starting
          seed for the randomn number generator which is used to generate 
          slopes at which the fit is performed, allowing the same random number
          sequence to be used multiple times for testing purposes. If disabled,
          the random number sequence will be initialized from the system clock
          and the numbers will be different each time the program is run.
        </description>
        <inclusions>
          <item>SEED_NUMBER</item>
        </inclusions>
      </parameter>
      <parameter name="SEED_NUMBER">
        <type>integer</type>
        <brief>
          Starting Seed Number
        </brief>
        <description>
          Starting seed number for randomn number generator
        </description> 
        <internalDefault>None Specified</internalDefault>
      </parameter>
    </group>
  </groups>
</application>

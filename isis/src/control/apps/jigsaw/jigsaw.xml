<?xml version="1.0"?>
<application name="jigsaw" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://isis.astrogeology.usgs.gov/Schemas/Application/application.xsd">
  <brief>
    Improves camera pointing and a whole lot more!
  </brief>

  <description>
    <p>
      This program performs a bundle adjustment on a group of overlapping Isis 3, level 
      1 cubes from framing and/or line-scan cameras.  The adjustment simultaneously 
      refines the selected image geometry information (camera pointing, spacecraft 
      position) and control point coordinates (x,y,z or lat,lon,radius) to reduce 
      boundary mismatches in mosaics of the images.  The application assumes spiceinit 
      has been run on the input cubes so that SPICE is included in the Isis 3 cube 
      labels in the Kernels group.
    </p>  
<!--
    <img src='assets/higlob_diagram.png' alt='Diagram of output pixel groups' width='444' height='520' />
-->
    <p>
      In order to run the program the user must provide a list of input cubes, an 
      input control net, the name of an output control net, and the adjustment 
      parameters. The program outputs a new control net that includes the initial 
      state of the points in the network and their final state after the adjustment.  
      The SPICE in the cube files is updated at the end of the adjustment only if it 
      converges and the adjusted flag is turned on.  Optional output files can be 
      selected to provide more information for analyzing the results.
    </p>
    <p>
      The bundle adjustment solution minimizes the sum of the squares of the weighted 
      residuals of the image Spice and control point 3-d positions included in the 
      solution.  The measured sample/line positions associated with the control points 
      are not changed.
    </p>
  </description>

  <category>
    <categoryItem>Control Networks</categoryItem>
  </category>

  <seeAlso>
    <applications>
      <item>deltack</item>
      <item>qnet</item>
    </applications>
  </seeAlso>

  <history>
    <change name="Jeff Anderson" date="2007-04-27">
      Original version
    </change>
    <change name="Steven Lambright" date="2007-07-23">
       Changed category to Control Networks and corrected XML bugs
    </change>
    <change name="Debbie A. Cook" date="2007-10-05">
        Revised iteration report to list the errors and sigmas from the same iteration.  Previous version reported errors from previous iteration and sigmas from current iteration.
    </change>
    <change name="Christopher Austin" date="2008-07-03">
      Cleaned the Bundle Adjust memory leak and fixed the app tests.
    </change>
    <change name="Tracie Sucharski" date="2009-04-08">
      Added date to the Jigged comment in the spice tables.
    </change> 
    <change name="Tracie Sucharski" date="2009-04-22">
      If updating pointing, delete the CameraStatistics table from labels.
    </change>
    <change name="Mackenzie Boyd" date="2009-07-23">
      Modified program to write history to input cubes.
    </change>
    <change name="Debbie A. Cook" date="2010-08-12">
      Commented out Heldlist until mechanism in place to enter individual
      image parameter constraints.
    </change>
    <change name="Debbie A. Cook" date="2010-08-12">
      Merged Ken Edmundson version with system and binary control net.
    </change>
    <change name="Debbie A. Cook" date="2011-06-14">
      Modified code to prevent updates to cube files in held list.
    </change>
    <change name="Debbie A. Cook" date="2011-09-28">
      Removed SC_SIGMAS from user parameter list because it is not
      fully implemented; changed method name SPARSE to OLDSPARSE
      and CHOLMOD to SPARSE; and improved the documentation for
      the Isis3.3.0 release.
    </change>
  </history>

  <groups>
    <group name="Files">

      <parameter name="FROMLIST">
        <type>filename</type>
        <fileMode>input</fileMode>
        <brief>
          Cube list
        </brief>
        <description>
          This file contains a list of all cubes in the network
        </description>
        <filter>
          *.txt *.lis
        </filter>
      </parameter>

      <parameter name="HELDLIST">
        <type>filename</type>
        <internalDefault>none</internalDefault>
        <fileMode>input</fileMode>
        <brief>
          Held list
        </brief>
        <description>
          This file contains a list of all cubes whose orientation and position
          will be held in the adjustment.  These images will still be included
          in the solution, but their camera orientation and spacecraft position
          will be constrained to keep the values from changing.  This is an
          optional parameter and the default is to not hold any of the images.
        </description>
        <filter>
          *.txt *.lis
        </filter>
      </parameter>

      <parameter name="CNET">
        <type>filename</type>
        <fileMode>input</fileMode>
        <brief>
          Input control network
        </brief>
        <description>
          This file is a control network generated from programs such as 
          autoseed or qnet.  It contains the control points and associated
          measures.
        </description>
        <filter>
          *.net
        </filter>
      </parameter>

<!--  Removed until fully functional 2011-09-26
      <parameter name="SC_SIGMAS">
        <type>filename</type>
        <internalDefault>none</internalDefault>
        <fileMode>input</fileMode>
        <brief>
          Input spacecraft parameter uncertainties
        </brief>
        <description>
          This file contains a list of parameter uncertainties for position and 
        angle parameters (including those of velocity and acceleration). Format 
        is one instrument per line; entries separated by commas; as follows... 
          SPACECRAFTNAME/INSTRUMENTID, sPos, sPos(v), sPos(a), sAngles, 
          sAngles(v), sAngles(a). Any entries without values should be filled 
          with a -1.0 as a placeholder
        </description>
        <filter>
          *.csv *.txt
        </filter>
      </parameter>
-->

      <parameter name="ONET">
        <type>filename</type>
        <fileMode>output</fileMode>
        <brief>
          Output control network
        </brief>
        <description>
          This output file contains the updated control network with the final
          coordinates of the control points and residuals for each measurement.
        </description>
        <filter>
          *.net
        </filter>
      </parameter>
      </group>

    <group name="Solve Options">
      <parameter name="OBSERVATIONS">
        <brief> Keep instances of the same observation in different cube files the same</brief>
        <description>
            This option will solve for SPICE on all cubes with a matching
            observation number as though they were a single observation.  For 
            most missions, the default observation number is equivalent to the 
            serial number of the cube, and a single cube is an observation.
            However, for the Lunar Orbiter mission an image has a defined 
            observation number that is a substring of its serial number.  This
            feature allows the three subframes of a Lunar Orbiter High
            Resolution frame to be treated as a single observation when this 
            option is used.  Otherwise each subframe is adjusted independently.
        </description>
        <type>boolean</type>
        <default>
          <item>No</item>
        </default>
      </parameter>

      <parameter name="RADIUS">
        <brief> Solve for local radii of points</brief>
        <description>
            Select this option to solve for the local radius of each control
            point.  If this button is not turned on, the radii of the points
            will not change from the cube's shape model.
        </description>
        <type>boolean</type>
        <default>
          <item>No</item>
        </default>
      </parameter>
      
      <parameter name="UPDATE">
        <brief> Update cube label</brief>
        <description>
            When this option is selected, the application will update the labels  
            of the individual cubes in the FROMLIST with the final values from 
            the solution if the adjustment converges.  The results are written 
            to the SPICE blobs attached to the cube, overwriting the previous
            values.  If this option is not selected, the cube files are not
            changed.  All other output files are still created.
        </description>
        <type>boolean</type>
        <default>
          <item>No</item>
        </default>
      </parameter>

      <parameter name="METHOD">
        <type>string</type>
        <brief> Matrix solution method</brief>
        <default>
          <item>SPARSE</item>
        </default>
        <description>
            Enter the desired method to use to solve the matrix.  Methods will
            vary in speed and accuracy.   The default, SPARSE, is the preferred
            method because of speed and memory usage.  
        </description>
        <list>
        <option value="SPARSE">
          <brief>CholMod (sparse)</brief>
          <description>
            Solve with CholMod sparse decomposition.
          </description>
          </option>
          <option value="SPECIALK">
            <brief>SpecialK (dense)</brief>
            <description>
            Solve with Cholesky dense decomposition.
            </description>
          </option>
<!--          <option value="SVD">
            <brief> Single Value Decomposition</brief>
            <description>
                      Solve the matrix using the method of single value
                      decomposition.  This method is very accurate, but slow.
            </description>
          </option>
          <option value="QRD">
            <brief> QR Decomposition</brief>
            <description>
                      Solve the matrix using the method of QR
                      decomposition, where Q is an orthogonal matrix such that Q
                      transpose * Q =I, and R is an upper triangular matrix. 
            </description>
          </option>
-->
          <option value="OLDSPARSE">
            <brief> Sparse matrix solver</brief>
            <description> 
              Solve the matrix using a sparse matrix solver.
                Note:  Sparse solver will not work on Sun/Solaris, QRD will be 
                          used.
            </description>
          </option>
        </list>
      </parameter>

      <parameter name="ERRORPROPAGATION">
        <brief> Compute variance-covariance matrix</brief>
        <description>
            Select this option to compute the variance-covariance matrix of the 
            parameters.  The parameter uncertainties can be computed from this
            matrix.
        </description>
        <type>boolean</type>
        <default>
          <item>No</item>
        </default>
      </parameter>

      <parameter name="OUTLIER_REJECTION">
      <brief> Auto-rejection of outliers</brief>
      <description>
          Select this option to perform automatic outlier detection and rejection. 
      </description>
      <type>boolean</type>
      <default>
        <item>No</item>
      </default>
    </parameter>
    </group>

    <group name="Convergence Criteria">
      <parameter name="SIGMA0">
        <brief> standard deviation of unit weight
        </brief>
        <description>
          Converges on stabilization of Sigma0.  Convergence occurs when the change
          in sigma0 between iterations is less than or equal to Sigma0.
        </description>
        <type>double</type>
        <default>
          <item>1.0e-10</item>
        </default>
      </parameter>

      <parameter name="MAXITS">
        <brief> iterations
        </brief>
        <description>
          Maximum number of times to iterate.  The application stops iterating at
          MAXIT, or when convergence is reached.
        </description>
        <type>integer</type>
        <default>
          <item>50</item>
        </default>
      </parameter>
      </group>

    <group name="Camera Pointing Options">
      <parameter name="CKDEGREE">
        <type>integer</type>
        <default>
          <item>2</item>
        </default>
        <brief>
          Degree of polynomial fit to original camera angles
        </brief>
        <description>
                The degree of the polynomial fit to the original camera angles 
                and used to generate apriori camera angles for the first 
                iteration.
        </description>
      </parameter>
      <parameter name="SOLVEDEGREE">
        <type>integer</type>
        <default>
          <item>2</item>
        </default>
        <brief>
          The degree of the polynomial being fit to in the bundle adjustment
        </brief>
        <description>
               The degree of the polynomial being fit to in the bundle adjust 
               solution.  This polynomial can be different from the one used to 
               generate the apriori camera angles used in the first iteration.  
               In the case of an instrument with a jitter problem, a higher 
               degree polynomial fit to each of the camera angles might provide 
               a better solution (smaller errors).
        </description>
      </parameter>
      <parameter name="CAMSOLVE">
        <type>string</type>
        <brief> Camera pointing parameters to include in the bundle adjustment</brief>
        <default>
          <item>ANGLES</item>
        </default>
        <description>
               This parameter is used to specify which, if any,  camera 
               pointing parameters to include in the adjustment.
        </description>
        <list>
          <option value="NONE">
            <brief> Don't solve for any camera pointing factors</brief>
            <description>
                   If this option is selected, no camera pointing parameters  
                   will be adjusted.
            </description>
          </option>

          <option value="ANGLES">
            <brief>Solve for camera angles: angle1 and angle2, and optionally twist</brief>
            <description>
                   Camera angles in each cube will be adjusted in the solution, 
                   but not angular velocities or accelerations. Adjustments are 
                   not applied unless the solution converges and UPDATE is 
                   selected.
            </description>
          </option>

          <option value="VELOCITIES">
            <brief>Solve for camera angles AND their angular velocities</brief>
            <description>
                   Camera angles (angle1, angle2, and optionally twist) and 
                   their angular velocities will be adjusted in the solution.
            </description>
          </option>

          <option value="ACCELERATIONS">
            <brief>Solve for camera angles, their angular velocities and accelerations</brief>
            <description>
                   Camera angles (angle1, angle2, and optionally twist), 
                   the angular velocities and accelerations will be 
                   adjusted in the solution.
            </description>
          </option>

          <option value="ALL">
            <brief>Solve for all coefficients in the polynomials fit to the camera angles.</brief>
            <description>
                   If this option is selected, all coefficients of the solve
                   equation will be adjusted in the solution (SOLVEDEGREE+1 
                   coefficients)
            </description>
          </option>
        </list>
      </parameter>

      <parameter name="TWIST">
        <brief> Solve for twist</brief>
        <description>
               If this option is selected, the twist angle will be adjusted in the 
               bundle adjustment solution.
        </description>
        <type>boolean</type>
        <default>
          <item>Yes</item>
        </default>
      </parameter>
    </group>

    <group name="Spacecraft Options">
      <parameter name="SPSOLVE">
        <type>string</type>
        <brief> Spacecraft position parameters to include in the adjustment</brief>
        <default>
          <item>NONE</item>
        </default>
        <description>
               This parameter is used to specify which, if any,  spacecraft 
               position parameters to include in the adjustment.
        </description>
        <list>
          <option value="NONE">
            <brief>Don't solve for any spacecraft position factors</brief>
            <description>
                   No spacecraft position factors will be adjusted.  A camera 
                   angle factor must be included in the adjustment in order for 
                   the application to run.
            </description>
          </option>

          <option value="POSITION">
            <brief>Solve for the spacecraft positions</brief>
            <description>
                   Spacecraft positions will be adjusted in the solution, but 
                   not the velocity or the acceleration.
            </description>
          </option>

          <option value="VELOCITIES">
            <brief>Solve for the spacecraft positions and velocities</brief>
            <description>
                   Spacecraft positions will be adjusted in the solution, as 
                   well as the velocities of the spacecraft at each instance.
            </description>
          </option>

          <option value="ACCELERATIONS">
            <brief>Solve for the spacecraft positions, velocities, and accelerations</brief>
            <description>
                   Spacecraft positions will be adjusted in the solution, as well 
                   as the velocities and accelerations of the spacecraft at each 
                   instance.
            </description>
          </option>
        </list>
      </parameter>
      </group>

      <group name="Parameter Uncertainties">
        <parameter name="POINT_LATITUDE_SIGMA">
          <brief> Global latitude uncertainty for all points (meters)
          </brief>
          <description> 
                 This optional value will be used as the global latitude 
                 uncertainty for all points.  Units are meters.
          </description>
          <type>double</type>
          <default>
            <item>-1.0</item>
          </default>
        </parameter>

        <parameter name="POINT_LONGITUDE_SIGMA">
          <brief> Global longitude uncertainty for all points (meters)
          </brief>
          <description> 
                 This optional value will be used as the global longitude 
                 uncertainty for all points. Units are meters. 
          </description>
          <type>double</type>
          <default>
            <item>-1.0</item>
          </default>
        </parameter>

        <parameter name="POINT_RADIUS_SIGMA">
          <brief> Global radius uncertainty for all points (meters)
          </brief>
          <description> 
                 This value will be used as the global radius uncertainty for 
                 all points.  Units are meters.
          </description>
          <type>double</type>
          <default>
            <item>-1.0</item>
          </default>
        </parameter>

        <parameter name="SPACECRAFT_POSITION_SIGMA">
          <brief> Global uncertainty for spacecraft coordinates (meters)
          </brief>
          <description> 
                 This value will be used as the global uncertainty for spacecraft 
                 coordinates.  Units are meters.
          </description> 
          <type>double</type>
          <default>
            <item>-1.0</item>
          </default>
        </parameter>

        <parameter name="SPACECRAFT_VELOCITY_SIGMA">
          <brief> Global uncertainty for spacecraft velocity (meters/second)
          </brief>
          <description> 
                 This value will be used as the global uncertainty for spacecraft 
                 velocity.  Units are meters/second.
            (meters)</description> 
          <type>double</type>
          <default>
            <item>-1.0</item>
          </default>
        </parameter>

        <parameter name="SPACECRAFT_ACCELERATION_SIGMA">
          <brief> Global uncertainty for spacecraft acceleration 
            (meters/second/second)</brief>
          <description> 
                 This value will be used as the global uncertainty for 
                 spacecraft acceleration.  Units are meters/second/second.
          </description> 
          <type>double</type>
          <default>
            <item>-1.0</item>
          </default>
        </parameter>

        <parameter name="CAMERA_ANGLES_SIGMA">
          <brief> global uncertainty for camera angles 
            (decimal degrees)</brief>
          <description> 
                 This value will be used as the global uncertainty for camera 
                 angles.  Units are decimal degrees.
          </description> 
          <type>double</type>
          <default>
            <item>-1.0</item>
          </default>
        </parameter>

        <parameter name="CAMERA_ANGULAR_VELOCITY_SIGMA">
          <brief> Global uncertainty for camera angular velocity 
            (decimal degrees/second)</brief>
          <description> 
                 This value will be used as the global uncertainty for camera 
                 angular velocity.  Units are decimal degrees/second.
          </description> 
          <type>double</type>
          <default>
            <item>-1.0</item>
          </default>
        </parameter>

        <parameter name="CAMERA_ANGULAR_ACCELERATION_SIGMA">
          <brief> global uncertainty for camera angular acceleration 
            (decimal degrees/second/second)</brief>
          <description> 
                 This value will be used as the global uncertainty for camera 
                 angular acceleration.  Units are decimal degrees/second/second.
          </description> 
          <type>double</type>
          <default>
            <item>-1.0</item>
          </default>
        </parameter>
        </group>

        <group name="Output Options">

       <parameter name="FILE_PREFIX">
            <type>string</type>
            <internalDefault>none</internalDefault>
            <brief>output file prefix</brief>
            <description>
                output file prefix
            </description>
        </parameter>

        <parameter name="BUNDLEOUT_TXT">
          <brief> Standard bundle output file - bundleout.txt
          </brief>
          <description> 
                 Selection of this parameter flags generation of the standard
                 bundle output file
          </description>
          <type>boolean</type>
          <default>
            <item>yes</item>
          </default>
        </parameter>

        <parameter name="OUTPUT_CSV">
          <brief> Outputs point and image data (body-fixed) to csv file - bundleout_points.csv
          </brief>
          <description> 
                 Selection of this parameter flags output of point and image data
                 (in body-fixed coordinates) to csv file.
          </description>
          <type>boolean</type>
          <default>
            <item>yes</item>
          </default>
        </parameter>

        <parameter name="RESIDUALS_CSV">
          <brief> Outputs image coordinate residuals to csv file - residuals.csv</brief>
          <description> 
                 Selection of this parameter flags output of image coordinate 
                 residuals to a csv file
          </description>
          <type>boolean</type>
          <default>
            <item>yes</item>
          </default>
        </parameter>
      </group>

    </groups>
</application>
